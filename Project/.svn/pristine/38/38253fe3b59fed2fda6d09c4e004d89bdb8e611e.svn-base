/// <reference path="../Content/js/jx.common.js" />
/// <reference path="../Content/js/jquery-2.1.3.min.js" />

var product = {}
product.list = function () {
    product.cf();
    product.quickedit();
    product.bindclick();
    product.search();
}
product.pagechange = function () {
    product.quickedit();
    product.bindclick();
}
product.search = function () {
    var $form = $('#form1');
    $('.submit').on('click', function () {
        $form.submit();
    })
}
product.get = function (productid, func) {
    $.ajax({
        type: "POST",
        url: "/product/get",
        data: { productid: productid },
        dataType: "json",
        cache: true,
        success: function (response) {
            if (response.status) {
                func(response.data);
            }
            else {
                jx.alert("失败了");
            }
        }
    });
}

// classification
product.cf = function () {
    product.cflist = null;
    //分类
    product.cflist = $('select.cf');
    product.cflist.not("#cf3").on("change", function () {
        var $this = $(this);
        var index = parseInt($this.attr("id").replace("cf", ""));
        var cfid = parseInt($this.val());
        product.cfclearoption(index);
        if (cfid == 0) {
            return false;
        }
        product.getcfbyid(index, cfid);
    });
    product.getcfbyid(0, 0);
}
product.getcfbyid = function (index, cfid) {
    $.ajax({
        type: "post",
        url: "/classification/getcfbyparentid",
        data: { parentid: cfid },
        dataType: "json",
        success: function (data) {
            var $cf = product.cflist.eq(index);
            if (data.status) {
                var arr = [];
                $.each(data.data, function (i, item) {
                    arr.push("<option value='" + item.CFID + "'>" + item.ChineseName + "</option>");
                });
                $cf.find("option").slice(1).remove();
                $cf.append(arr.join(''));
                if (data.msg == "1")
                    $cf.next().hide();
                else
                    $cf.next().show();

            }
        }
    });
}
product.cfclearoption = function (index) {
    product.cflist.each(function (i, item) {
        if (i < index)
            return true;
        product.cflist.eq(i).find("option").slice(1).remove();
    });
}
product.gotop = function () {
    $("html,body").animate({ scrollTop: $("#tablelist").offset().top }, 200);
}
//quickedit
product.quickedit = function () {

    //赠品
    var $gift = $('input[name=giftid]');
    $gift.on("blur", function () {
        var $this = $(this)
        var id = $this.val();
        if (id.isnum()) {
            product.get(id, function (data) {
                $this.next().remove();
                $this.after("<div class='aotu-info'>自动读取：" + data.ChineseName + "</div>");
            });
        }
    });

    //数量
    $('div.setNumber').each(function (i, item) {
        var $this = $(item);
        var $input = $this.find("input");
        var $jian = $this.find(".jian");
        var $jia = $this.find(".jia");
        $jia.on("click", function () {
            var count = parseInt($input.val());
            if (count < 99)
                count++;
            $input.val(count);
        });
        $jian.on("click", function () {
            var count = parseInt($input.val());
            if (count > 0)
                count--;
            $input.val(count);
        });
        $input.on("blur keyup change", function () {
            var count = parseInt($input.val());
            if (!count.toString().isnum()) {
                count = 1;
            }
            else {
                if (count > 99) count = 99;
                if (count < 0) count = 0;
            }
            $input.val(count);
        });
    });
    //保存
    $('a.save').on("click", function () {

        var $td = $(this).parent();
        var productid = $(this).attr("productid");
        var giftid = $td.find("input[name=giftid]").val();
        var giftcount = $td.find("input[name=giftcount]").val();
        var freeship = $td.find("input[name=freeship]").prop('checked') ? 1 : 0;
        var top = $td.find("input[name=top]").prop('checked') ? 1 : 0;
        var recommend = $td.find("input[name=recommend]").prop('checked') ? 1 : 0;
        var selling = $td.find("select[name=selling]").val();
        var actions = $td.find("select[name=actions]").val();
        var sort = $td.find("input[name=sort]").val();

        $.ajax({
            type: "POST",
            url: "/product/quickedit",
            data: {
                productid: productid,
                productgiftid: giftid,
                productgiftcount: giftcount,
                IsFreeShip: freeship,
                IsTop: top,
                IsRecommend: recommend,
                Selling: selling,
                Actions: actions,
                Sort: sort
            },
            dataType: "json",
            success: function (result) {
                if (result.status) {
                    jx.alert("编辑成功!");
                }
                else {
                    jx.error("编辑失败!");
                }
            }
        });
    });
}

//list.open
product.bindclick = function () {
    $('a[name=activty]').on("click", function () {
        var $this = $(this);
        var productid = $this.parent().parent().attr("productid");
        jx.open("/product/activity?productid=" + productid, { height: 600, width: 450 });
        return false;
    });

    $('a[name=price]').on("click", function () {
        var $this = $(this);
        var productid = $this.parent().parent().attr("productid");
        jx.open("/product/price?productid=" + productid, { height: 400, width: 500 });
        return false;
    });

    $('a[name=related]').on('click', function () {
        var $this = $(this);
        var productid = $this.parent().parent().attr("productid");
        window.open("/product/related?productid=" + productid);
        return false;
    })
}

//file
product.uploadfile = function () {
    //默认参数
    var defaultSetting = {
        "height": 24,
        'width': 80,
        'swf': '/js/uploadify3.2.1/uploadify.swf?v=' + new Date().getMilliseconds(),
        'fileSizeLimit': "1024KB",
        'method': "post",
        'fileTypeDesc': '只允许上传gif,jpg,jpeg,png图片',
        'fileTypeExts': '*.gif; *.jpg; *.png',
        "removeCompleted": false,
        'wmode': 'transparent',
        'preventCaching': false,
        'auto': true,
        'overrideEvents': ['onUploadProgress'],
        'multi': false,
        'buttonText': '上传图片'
    };

    $('.flooSpecial>div').each(function (i, item) {
        var index = i + 1;
        var $imageupload = $("#upload" + index);
        var $imagelist = $('#updateImgWrap' + index);
        setTimeout(function () {
            //专业参数
            var prosetting = {
                'uploader': '/floor/upload',
                'queueID': 'updateImgWrap' + index,
                'itemTemplate': '<div  id="${fileID}" class="upImage"><span>上传中</span><a style="display: none;" href="javascript:;" class="removeImgeCha">×</a></div>',
                'onSelect': function () {
                    if ($imagelist.children().length > 1)
                        $imagelist.find(".upImage").eq(0).remove();
                },
                "onUploadSuccess": function (file, data, response) {
                    data = $.parseJSON(data);
                    if (!data.status) {
                        $f.find("span").text("上传失败!");
                        return false;
                    }
                    var $f = $('#' + file.id);
                    $f.find("span").replaceWith("<img src='" + data.data + "' />");
                    $f.parent().prev().find("input:hidden").val(data.data);
                    $imageupload.uploadify('disable', true);
                    $imageupload.uploadify('settings', 'buttonText', '已上传');
                    $f.find("a").on("click", function () {
                        if (!confirm("确定要删除图片吗?"))
                            return false;
                        var $this = $(this);
                        $this.parent().remove();
                        $imageupload.uploadify('disable', false);
                        $imageupload.uploadify('settings', 'buttonText', '上传图片');
                        return false;
                    });
                }
            };
            //合并上传参数
            $.extend(prosetting, defaultSetting);
            $imageupload.uploadify(prosetting);
        }, 10);

    });
    //显示/隐藏
    $('.updateImgWrap').on('mouseover mouseout', 'div', function (event) {
        var $this = $(this).find("a");
        if ($this.length == 0) return false;
        switch (event.type) {
            case "mouseover": $this.show(); break;
            case "mouseout": $this.hide(); break;
        }
    });
}
//price
product.price = function () {
    var $productid = $('i[nid=productid]');
    var $productode = $('i[nid=productcode]');
    var $chinseeName = $('i[nid=chinesename]');
    var $marketprice = $('input[name=marketprice]');
    var $tradeprice = $('input[name=tradeprice]');
    var $mobileprice = $('input[name=mobileprice]');
    var $hidden_productid = $('#ProductID');

    var $form = $('#form1');
    $form.validate({
        errorPlacement: function (error, element) {
            error.insertAfter(element.next());
        },
        submitHandler: function (form) {
            $.ajax({
                type: "POST",
                url: "/product/price",
                data: $form.serialize(),
                dataType: "json",
                success: function (result) {
                    if (result.status) {
                        jx.alert("编辑成功!");
                    } else {
                        jx.error("编辑失败!");
                    }
                }
            });
        }
    });
    $('a.save').on('click', function () { $form.submit(); });

    $('#packlist li').on("click", function () {
        var $this = $(this);
        if ($this.hasClass("active"))
            return false;

        var productid = $this.attr("productid");
        product.get(productid, function (data) {
            $productid.text(data.ProductID);
            $productode.text(data.ProductCode);
            $chinseeName.text(data.ChineseName + (data.Specifications.length > 0 ? " [" + data.Specifications + "]" : ""));
            $marketprice.val(data.MarketPrice);
            $tradeprice.val(data.TradePrice);
            $mobileprice.val(data.MobilePrice);
            $hidden_productid.val(data.ProductID);
            $this.siblings().removeClass();
            $this.addClass("active");
        });

    });
}

var productedit = {};
productedit.common = function () {
    //属性
    var $paras = $('input[name=ParameterType]');
    var $drug = $('.drug');
    $paras.on('click', function () {
        var $this = $(this);
        $paras.prop("checked", false);
        $this.prop("checked", true);
        if ($this.val() == "1") {
            $drug.show();
        }
        else {
            $drug.hide();
        }
    });
    if ($(".ptype :checked").val() == "1") {
        $drug.show();
    }


}


productedit.init = function () {
    productedit.common();

    //表单
    $("a.save").on('click', function () {
        $form.submit();
    });
    var $form = $('#formproduct');
    $form.validate({
        errorPlacement: function (error, element) { error.insertAfter(element); },
        submitHandler: function () {
            $.ajax({
                type: "POST", url: "/product/edit", data: $form.serialize(), dataType: "json", success: function (result) {
                    if (result.status) { jx.alert("编辑成功!"); } else {
                        jx.error("编辑失败!");
                    }
                }
            });
            return false;
        }
    });
    $('input[name=CADN],input[name=ChineseName],input[name=Manufacturer],input[name=ManufacturerAddress]').on("blur change keyup", function () {
        var $this = $(this);
        var $other = $('input[name=' + $this.attr("name") + "1");
        $other.val($this.val());
    });

    //多商品编辑
    $('a[name=del]').on('click', function () { });


    $.get("/product/getmanufacturer", function (result) {
        var datas = result.data;
        var $m = $('input[name=Manufacturer]');
        var $maddrss = $('input[name=ManufacturerAddress]');
        var $hidden_m = $m.prev();
        $m.autocomplete(datas, {
            formatItem: function (row, i, max) {
                return "<table width='400px'><tr><td align='left'>" + row.mname + "</td><td align='right'></td></tr></table>";
            },
            formatMatch: function (row, i, max) {
                return row.mname.toString();
            }
        }).result(function (event, data, formatted) {
            $hidden_m.val(data.mid);
            $maddrss.val(data.maddress);
        });
    });
}
productedit.keyword = function () {
    //关键字
    var url = "/product/getkeywords";
    var $keyword = $('#keyword');
    var $keylist = $('#keywordlist');
    var $exists = $('#existskeyword');
    var t = 0;
    //seach
    $keyword.on("blur keyup", function () {
        var q = $keyword.val();
        if (q == $keyword.attr("tip")) {
            return false;
        }
        clearTimeout(t);
        t = setTimeout(function () {
            $keylist.find("p").remove().end().find("ul>li").remove();
            $keyword.attr("tip", q);
            productedit.getkeyword(q, function (data) {
                if (data.status) {
                    $keylist.prepend("<p class='xingRed noneTag'>检索到相关匹配标签，您可以直接点击贴上标签，或直接添加此标签！</p>");
                    var lis = [];
                    for (var i = 0; i < data.data.length; i++) {
                        lis.push("<li><a href='#' keywordid='" + data.data[i].KeywordID + "'>" + data.data[i].ChineseName + "</a><span>贴上</span></li>");
                    }
                    $keylist.find("ul").append(lis.join(''));
                } else {
                    $keylist.append("<p class='xingRed noneTag'>未检索到标签，可以直接添加此标签！</p>")
                }
            });
        }, 1000);
    });
    //add /related
    $keylist.on('click', 'span', function () {
        var $a = $(this).prev();
        var kid = $a.attr("keywordid");
        var kw = $a.text();
        $.ajax({
            type: "POST",
            url: "/product/addkeyword",
            data: { productid: productid, keywordid: kid },
            dataType: "json",
            success: function (data) {
                if (data.status) {
                    $exists.append(" <li><a href='#' keywordid='" + kid + "'>" + kw + "</a><i>×</i></li>");
                    $a.parent().remove();
                }
                else {
                    jx.error('失败了!');
                }
            }
        });
    });
    //add
    $('a[name=addkeyword]').on("click", function () {
        var $this = $(this);
        var name = $this.prev().val();
        if (name.length != 0) {
            $.ajax({
                type: "POST",
                url: "/product/addkeyword",
                data: { productid: productid, keywordid: 0, chinesename: name },
                dataType: "json",
                success: function (data) {
                    if (data.status) {
                        $exists.append(" <li><a href='#' keywordid='" + data.data + "'>" + name + "</a><i>×</i></li>");
                        $keylist.find("p").remove().end().find("li").remove();
                        $this.val('');
                    }
                    else {
                        jx.error('失败了!');
                    }
                }
            });
        }
        return false;
    });
    //del
    $exists.on("click", "i.del", function () {
        var $this = $(this);
        var keywordid = $this.prev().attr("keywordid");
        jx.del(function () {
            $.ajax({
                type: "POST",
                url: "/product/DelKeyword",
                data: { productid: productid, keywordid: keywordid },
                dataType: "json",
                success: function (data) {
                    if (data.status) {
                        $this.parent().remove();
                    }
                    else {
                        jx.error(data.msg);
                    }
                }
            });
        })
    });
}
productedit.getkeyword = function (q, func) {
    $.ajax({
        type: "POST",
        url: "/product/getkeywords",
        data: { q: q },
        dataType: "json",
        success: function (data) {
            func(data);
        }
    });
}
productedit.upload = function () {
    //默认参数
    var defaultSetting = {
        "height": 24,
        'width': 80,
        'swf': '/js/uploadify3.2.1/uploadify.swf?v=' + new Date().getMilliseconds(),
        'fileSizeLimit': "1024KB",
        'method': "post",
        'fileTypeDesc': '只允许上传gif,jpg,jpeg,png图片',
        'fileTypeExts': '*.gif; *.jpg; *.png',
        "removeCompleted": false,
        'wmode': 'transparent',
        'preventCaching': false,
        'auto': true,
        'overrideEvents': ['onUploadProgress'],
        'multi': false,
        'buttonText': '上传图片'
    };

    //说明书
    var $shuoming = $('#shuoming');
    var $shuomingimg = $('#shuomingimg');
    var shuomingsetting = {
        'formData': { productid: productid },
        'uploader': '/product/uploadshuoming',
        'queueID': 'shuomingimg',
        'itemTemplate': '<div  id="${fileID}" class="upImage"><span>上传中</span><a href="#" class="closeBtn" style="display:none;">X</a></div>',
        'onSelect': function () {
            if ($shuomingimg.children().length > 1)
                $shuomingimg.find(".upImage").eq(0).remove();
        },
        "onUploadSuccess": function (file, data, response) {
            data = $.parseJSON(data);
            if (!data.status) {
                $f.find("span").text("上传失败!");
                return false;
            }
            var $f = $('#' + file.id);
            $f.find("span").replaceWith("<img src='" + data.data + "' />");
        }
    }
    $shuomingimg.on("click", 'a', function () {
        var $this = $(this);
        jx.del(function () {
            productedit.delimage($this, productid, 3, 0);
        });
        //$shuoming.uploadify('disable', false);
        //$shuoming.uploadify('settings', 'buttonText', '上传图片');
        return false;
    });
    $.extend(shuomingsetting, defaultSetting);
    $shuoming.uploadify(shuomingsetting);
    //商品5张图
    $('#uploadimage>div').each(function (i, item) {
        var $this = $(item);
        var $btn = $this.find("#image" + i);
        var $img = $this.find("#imagequeue" + i);
        var imagesetting = {
            'formData': { productid: productid, index: (i + 1) },
            'uploader': '/product/uploadimage',
            'queueID': 'imagequeue' + i,
            'itemTemplate': '<div  id="${fileID}" class="upImage"><span>上传中</span><a href="#" class="closeBtn" style="display:none;">X</a></div>',
            'onSelect': function () {
                if ($img.children().length > 1)
                    $img.find(".upImage").eq(0).remove();
            },
            "onUploadSuccess": function (file, data, response) {
                data = $.parseJSON(data);
                if (!data.status) {
                    $f.find("span").text("上传失败!");
                    return false;
                }
                var $f = $('#' + file.id);
                $f.find("span").replaceWith("<img src='" + data.data + "' />");
            }
        };
        $.extend(imagesetting, defaultSetting);
        $btn.uploadify(imagesetting);
        $img.on("click", 'a', function () {
            var $this = $(this);
            jx.del(function () {
                productedit.delimage($this, productid, 1, i);
            });
            return false;
        });
    });
    $('#descuploadimage>div').each(function (i, item) {
        var $this = $(item);
        var $btn = $this.find("#descimage" + i);
        var $img = $this.find("#descimagequeue" + i);
        var imagesetting = {
            'formData': { productid: productid, index: (i + 1) },
            'uploader': '/product/uploadotherimage',
            'queueID': 'descimagequeue' + i,
            'itemTemplate': '<div  id="${fileID}" class="upImage"><span>上传中</span><a href="#" class="closeBtn" style="display:none;">X</a></div>',
            'onSelect': function () {
                if ($img.children().length > 1)
                    $img.find(".upImage").eq(0).remove();
            },
            "onUploadSuccess": function (file, data, response) {
                data = $.parseJSON(data);
                if (!data.status) {
                    $f.find("span").text("上传失败!");
                    return false;
                }
                var $f = $('#' + file.id);
                $f.find("span").replaceWith("<img src='" + data.data + "' />");
            }
        };
        $.extend(imagesetting, defaultSetting);
        $btn.uploadify(imagesetting);

        $img.on("click", 'a', function () {
            var $this = $(this);
            jx.del(function () {
                productedit.delimage($this, productid, 2, i);
            });
            return false;
        });

    });
    //显示/隐藏
    $('.every-one-info').on('mouseover mouseout', '.informa-imgWrap', function (event) {
        var $this = $(this).find(".closeBtn");
        if ($this.length == 0) return false;
        switch (event.type) {
            case "mouseover": $this.show(); break;
            case "mouseout": $this.hide(); break;
        }
    });
}
productedit.delimage = function ($this, productid, t, index) {
    $.ajax({
        type: "POST",
        url: "/product/delimage",
        data: { productid: productid, t: t, index: index },
        dataType: "json",
        success: function (data) {
            if (data.status) {
                $this.parent().empty();
            } else {
                jx.error("删除失败了!");
            }
        }
    });
}
productedit.audit = function () {
    var $pass = $('a[name=pass]');
    var $notpass = $('a[name=notpass]');
    $pass.on("click", function () {
        jx.confirm("确定要通过审核吗?", function () {
            var $parent = $pass.parent();
            var productid = $parent.attr("productid");
            var type = $parent.attr("audittype");
            $.ajax({
                type: "POST",
                url: "/audit/product",
                data: { productid: productid, type: type, status: 1 },
                dataType: "json",
                success: function (result) {
                    if (result.status) {
                        jx.alert("审核通过!", function () {
                            location.reload();
                            return false;
                        });
                    }
                    else {
                        jx.error("审核失败!" + result.msg);
                    }
                }
            });
        });
        return false;
    });
    var $notpass = $('a[name=notpass]');
    $notpass.on("click", function () {

        var $parent = $notpass.parent();
        var productid = $parent.attr("productid");
        var type = $parent.attr("audittype");
        jx.open("/audit/notpass?productid=" + productid + "&type=" + type, {
            width: 400, height: 400
        });
        return false;
    });

}


var productadd = {};
productadd.init = function () {
    productedit.common();
    productadd.operate();
    $.get("/product/getmanufacturer", function (result) {
        var datas = result.data;
        var $m = $('input[name=Manufacturer]');
        var $maddrss = $('input[name=ManufacturerAddress]');
        var $hidden_m = $m.prev();
        $m.autocomplete(datas, {
            formatItem: function (row, i, max) {
                return "<table width='400px'><tr><td align='left'>" + row.mname + "</td><td align='right'></td></tr></table>";
            },
            formatMatch: function (row, i, max) {
                return row.mname.toString();
            }
        }).result(function (event, data, formatted) {
            $hidden_m.val(data.mid);
            $maddrss.val(data.maddress);
        });
    });
}

productadd.operate = function () {
    //添加信息到数据
    var productcodes = [];
    var count = 0;
    var $hidden_count = $('input[name=hidden_count]');
    var $save = $('a[name=save]');
    var $guige = $('input[name=guige]');
    var $color = $('input[name=color]');
    var $size = $('input[name=size]');
    var $dushu = $('input[name=dushu]');
    var $productcode = $('input[name=productcode]');
    var $cadn = $('input[name=CADN]');
    var $chinesename = $('input[name=ChineseName]');

    var $table = $('#tablelist');
    $save.on("click", function () {
        var guige = $guige.val();
        var color = $color.val();
        var size = $size.val();
        var dushu = $dushu.val();
        var pcode = $productcode.val();
        var cadn = $cadn.val();
        var name = $chinesename.val();
        if (name.length == 0) {
            jx.alert('请填写商用名称');
            return false;
        }
        if (cadn.length == 0) {
            jx.alert("请填写通用名称");
            return false;
        }
        if (guige.length == 0) {
            jx.alert("请填写规格");
            return false;
        }
        if (pcode.length < 4) {
            jx.alert('请填写金象码');
            return false;
        }
        if (productcodes.indexOf(pcode) > -1) {
            jx.alert("该金象码重复!");
            return false;
        }
        if (count == 0) {
            $table.find("tbody").empty();
        }
        count++;
        var arr = [];
        arr.push('<tr>');
        arr.push("<td>" + count + "</td>");
        arr.push("<td></td>");
        arr.push("<td>" + pcode + "</td>");
        arr.push("<td>" + cadn + "</td>");
        arr.push("<td>" + name + "</td>");
        arr.push("<td>" + guige + "</td>");
        arr.push("<td>" + color + "</td>");
        arr.push("<td>" + size + "</td>");
        arr.push("<td>" + dushu + "</td>");
        arr.push("<td><a name='edit'>编辑</a><a name='del'>删除</a>");
        var attrs = [];
        attrs.push(pcode);
        attrs.push(guige);
        attrs.push(color);
        attrs.push(size);
        attrs.push(dushu);
        arr.push('<input type="hidden" name="newproduct' + count + '" value="' + attrs.join("|") + '" /></td></tr>');
        $table.find("tbody").append(arr.join(''));
        $guige.val('');
        $color.val('');
        $size.val('');
        $dushu.val('');
        $productcode.val('');
        productcodes.push(pcode);
        $hidden_count.val(count);
        return false;
    });


    var $form = $('#formproduct');
    var $submit = $('a[name=submit]');
    $submit.on('click', function () { $form.submit(); });
    $form.validate({
        rules: { BrandID: { required: true } },
        messages: { BrandID: { required: "请选择品牌" } },
        errorPlacement: function (error, element) { error.insertAfter(element); },
        submitHandler: function () {
            if ($submit.attr("isajax") == "1") {
                return false;
            }
            $submit.attr("isajax", "1").text("提交中...");
            $.ajax({
                type: "POST", url: "/product/addproduct", data: $form.serialize(), dataType: "json", success: function (result) {
                    if (result.status) {
                        var $next = $submit.next();
                        $next.removeClass("hide");
                        setTimeout(function () {
                            $next.addClass("hide");
                        }, 2000);
                    } else {
                        jx.error("编辑失败!");
                    }
                    $submit.attr("isajax", "0").text("提交");
                }
            });
            return false;
        }
    });
}


//活动 true
var productactivity = {
    init: function (tr$) {
        tr$.on("click", "a[name=activity]", function () {
            jx.open("/product/activity?productid=" + product.getProductID($(this)), null, 450, 620);
            return false;
        });
    },
    edit: function () {

        productactivity.$actprice = $('#actprice');
        productactivity.$actquantity = $('#actquantity');
        productactivity.$actdiscount = $('#actdiscount');
        productactivity.$actproductgift = $('#actproductgift');
        productactivity.$actdesc = $('#actdesc');
        productactivity.$actdate = $('div[name=actdate]');
        productactivity.$others = $('#others');
        productactivity.$actcoupon = $('#actcoupon');

        var type = $('#hidden_type').val();
        productactivity.setHide(false);
        productactivity.setShow(type);
        $('div.imitationSelect').select1(type, function (key, value) {
            productactivity.setHide(true);
            productactivity.setShow(key);
        });


        productactivity.bindInfo();
        productactivity.$actprice
            .add(productactivity.$actquantity)
            .add(productactivity.$actdiscount)
            .add(productactivity.$actproductgift)
            .add(productactivity.$actcoupon).on("blur keyup change", "input", function () {
                productactivity.validater();
            });


        productactivity.$actdate.on("focus", "input", function () {
            $(this).attr("readonly", "readonly");
            WdatePicker({ doubleCalendar: true, dateFmt: 'yyyy-MM-dd HH:mm', maxDate: '2099-12-31', minDate: new Date().toLocaleDateString() });
        });

        //提交表单
        $("a.submit").click(function () {
            if (productactivity.validater()) {
                $('#form1').submit();
            }
            else {
                jx.alert("请检查参数!");
            }
        });
    },
    setShow: function (key) {
        if (key == "0")
            return;

        var pa = productactivity;

        /*  包邮 = 1,满赠 = 2,满减 = 3,满返 = 4,满折 = 5,换购 = 6,折扣 = 7,直降 = 8*/
        //  判断有没有_ 选择需要显示的
        var type = 0;
        if (key.indexOf("_") > 0) {
            var arr = key.split('_');
            switch (arr[1]) {
                case "1": pa.$actprice.show(); break;
                case "2": pa.$actquantity.show(); break;
            }
            type = parseInt(arr[0]);
        } else {
            type = parseInt(key);
        }
        switch (type) {
            case 2: //赠品
                pa.$actproductgift.show();
                break;
            case 4: //优惠劵
                pa.$actcoupon.show();
                break;
            case 6: //换购 价格 赠品
                pa.$actproductgift.show();
                pa.$actdiscount.show().find(".discountmsg").text("* 请填写换购价格：").end().find(".discountunit").text("元");
            case 3: //满减
                pa.$actdiscount.show().find(".discountmsg").text("* 请填写减免金额：").end().find(".discountunit").text("元");
                break;
            case 5: //满折
                pa.$actdiscount.show().find(".discountmsg").text("* 请填写折扣：").end().find(".discountunit").text("折");
                break;
            case 7: //折扣
                pa.$actdiscount.show().find(".discountmsg").text("* 请填写折扣：").end().find(".discountunit").text("折");
                break;
            case 8: //直降
                pa.$actdiscount.show().find(".discountmsg").text("* 请填写优惠金额：").end().find(".discountunit").text("元");
                break;
        }
        pa.$actdesc.show();
        pa.$actdate.show();
        pa.$others.show();

    },
    setHide: function (isclear) {
        var pa = productactivity;
        pa.$actprice.hide();
        pa.$actproductgift.hide();
        pa.$actquantity.hide();
        pa.$actdiscount.hide();
        pa.$actdesc.hide();
        pa.$actdate.hide();
        pa.$others.hide();
        pa.$actcoupon.hide();
        if (isclear) {
            pa.$actprice.add(pa.$actproductgift).add(pa.$actquantity).add(pa.$actdiscount).add(pa.$actdesc).find("input").val("");
        }
    },
    bindInfo: function () {

        //商品名称读取
        var t;
        productactivity.$actproductgift.find("input").on("change blur", function () {

            var $product = $(this);
            var productid = parseInt($product.val());
            if (productid == $product.attr("productid")) {
                return false;
            }
            var $msg = $product.parent().next().html("");
            if (!isNaN(productid) && productid > 0) {
                t = setTimeout(function () {
                    $product.attr("productid", productid);
                    product.get(productid, function (data) {
                        $product.parent().next().html("商品名称：<a href='http://www.jxdyf.com/product/" + data.ProductID + ".html' target='_blank'>" + data.ChineseName + "</a>");
                        $product.attr("cname", data.ChineseName);
                        productactivity.validater();
                        clearTimeout(t);
                    });
                }, 500);
            }
        });
    },
    validater: function () {
        var ispass = true;
        //活动介绍
        var $actdesc = productactivity.$actdesc.find("textarea");
        var type = parseInt($('#hidden_type').val().substring(0, 1));
        var price = parseInt(productactivity.$actprice.find("input").val());
        var $quantity = productactivity.$actquantity.find("input")

        var quantity = parseInt($quantity.val());
        var unit = $quantity.next().text();

        var $gift = productactivity.$actproductgift.find("input");
        var giftid = parseInt($gift.val());
        var giftname = $gift.attr("cname") || "";

        var $discount = productactivity.$actdiscount.find("input");
        var discount = parseInt($discount.val());

        var couponno = $('#CouponBatchNo').val();
        var couponname = $('#CouponName').val();



        /*  包邮 = 1,满赠 = 2,满减 = 3,满返 = 4,满折 = 5,换购 = 6,折扣 = 7,直降 = 8 */
        var msg = '';
        switch (type) {
            case 1:
                if (price > 0)
                    msg = "满" + price + "元，即可享受包邮";
                else if (quantity > 0)
                    msg = "满" + quantity + unit + "，即可享受包邮";
                break;
            case 2:
                if (giftid > 0 && giftname.length > 0) {
                    if (price > 0)
                        msg = "满" + price + "元，即可获赠" + giftname;
                    else if (quantity > 0)
                        msg = "满" + quantity + unit + "，即可获赠" + giftname;
                }
                break;
            case 3:
                if (discount > 0) {
                    if (price > 0)
                        msg = "满" + price + "元，即可享受减" + discount + "元优惠";
                    else if (quantity > 0)
                        msg = "满" + quantity + unit + "，即可享受减" + discount + "元优惠";
                }
                break;
            case 4:

                if (couponno.length > 0 && couponname.length > 0) {
                    if (price > 0)
                        msg = "满" + price + "元，即可享受返券优惠";
                    else if (quantity > 0)
                        msg = "满" + quantity + unit + "，即可享受返券优惠";
                }
                break;
            case 5:
                if (discount > 0) {
                    if (price > 0)
                        msg = "满" + price + "元，即可享受" + discount + "折优惠";
                    else if (quantity > 0)
                        msg = "满" + quantity + unit + "，即可享受" + discount + "折优惠";
                    break;
                }
            case 6:
                if (giftid > 0 && giftname.length > 0) {
                    if (price > 0)
                        msg = "满" + price + "元，可加价换购商品1件";
                    else if (quantity > 0)
                        msg = "满" + quantity + unit + "，可加价换购商品1件";
                }
                break;
            case 7:
                if (discount > 0 && discount < 10)
                    msg = discount + "折优惠 全网最低";
                break;
            case 8:
                msg = "直降" + $discount.val() + "元，全网最低";
                break;
        }
        $actdesc.text(msg);
        return msg.length > 0;
    }
}

productactivity.successedit = function (data) {
    if (data.status) {
        jx.alert("编辑成功", function () {
            jx.closeAll();
        });
    } else {
        jx.error("编辑失败");
    }
}



//reated 关联
var related = {
    //编辑
    edit: function () {
        var $nav = $('div.setCommAttrHeader');
        var $content = $('div.setCommConterTab');
        $nav.on('click', "span", function () {
            var $this = $(this).addClass("active");
            $this.siblings().removeClass("active");
            $content.find("div.packagingInfo").addClass("hide").eq($this.index()).removeClass("hide");
        });

        this.packaging();
        this.tuijian();
        this.guige();
        this.zuhe();
    },

    //大包装
    packaging: function () {

        var $p = $('#packaging');
        var productid = parseInt($p.find(".pid").text());
        var productname = $p.find(".pname").text()
        var unit = $p.find(".unit").text()

        var $cancel = $p.find("a.cancel");
        var $quantity = $p.find("input[name=quantity]");
        var $price = $p.find("input[name=price]");
        var $viewname = $p.find("input[name=viewname]");
        var $save = $p.find("a[name=save]");
        $quantity.add($price).on("change keyup blur", function () {  //生成 viewname
            var str = '';
            var q = $quantity.val();
            var p = $price.val();
            if (q > 0 && p > 0)
                str = productname + q + unit + '装(每' + unit + '仅需￥' + (p / q).toFixed(2) + ')';
            $viewname.val(str);
        });
        //提交表单
        $p.on("click", "a[name=save]", function () {
            $('#form1').submit();
            return false;
        });
        $("#form1").validate({
            errorPlacement: function (error, element) {
                element.parent().append(error);
            },
            submitHandler: function (form) {
                var quantity = $quantity.val();
                var price = $price.val();
                var viewname = $viewname.val();
                $.post('/product/related_largepacking', { relatedid: 0, productid: productid, price: price, quantity: quantity, viewname: viewname }, function (data) {
                    if (data.status) {
                        if ($save.next().next().length == 0) {
                            var $gou = $("<p class='gou'>保存成功</p>")
                            $save.next().after($gou);
                            jx.autoHide($gou);
                            related.clearItem($p);
                            $p.find(".infoTable").load("/product/Related?type=1&productid=" + productid);
                        }
                    } else {
                        jx.alert("失败了!" + data.msg);
                    }
                    return false;
                });
            }
        });


        var isupdate = false;
        // 修改
        $p.on("click", "a[name=update]", function () {
            if (isupdate) {
                jx.alert("请先编辑完当前数据");
                return false;
            }
            isupdate = true;
            //操作数据
            var tds = $(this).parent().parent().children();
            var name = tds.eq(2).text();
            var price = tds.eq(3).text();
            tds.eq(2).html("<input name='name' style='width:300px;' value='" + name + "' />");
            tds.eq(3).html("<input name='price' style='width:80px;' value='" + price + "' />");
            tds.eq(5).html("<a href='#' name='updatedone'>保存</a>");
            return false;
        });
        $p.on("click", "a[name=updatedone]", function () {
            var $parent = $(this).parent();
            var tds = $(this).parent().parent().children();
            var $name = tds.eq(2).find("input");
            var $price = tds.eq(3).find("input");
            var name = $name.val();
            var price = $price.val();

            if (name.length > 0 && checkDecimal(price)) {
                $.post('/product/related_largepacking', { relatedid: $parent.attr("relatedid"), price: price, quantity: tds.eq(4).attr("q"), viewname: name }, function (data) {
                    if (data.status) {
                        $name.remove();
                        $price.remove();
                        tds.eq(2).text(name);
                        tds.eq(3).text(price);
                        tds.eq(5).html('<a href="#" name="update">编辑</a><a href="#" name="del">删除</a>');
                        isupdate = false;
                    } else {
                        jx.alert("失败了!" + data.msg);
                    }
                    return false;
                });

            }

            return false;
        });

        //删除
        $p.on("click", "a[name=del]", function () {
            var $this = $(this);
            var $parent = $this.parent();
            var relatedid = $parent.attr("relatedid");
            jx.del(function () {
                $.post("/product/related_del", { relatedid: relatedid }, function (result) {
                    if (result.status) {
                        $parent.parent().remove();
                    } else {
                        jx.alert("出错了!" + result.msg);
                    }
                });
            });
            return false;
        });
        $cancel.on("click", function () {
            $p.find(".updateTitle").addClass("hide");
            related.clearItem($p);
            $cancel.hide();
            if ($childproductid)
                $childproductid.val('0');
            return false;
        });
    },

    //推荐
    tuijian: function () {
        var $tuijian = $('#tuijian');
        var productid = parseInt($tuijian.find(".pid").text());

        // 保存
        $tuijian
            .on("click", "a.save", function () {
                var $this = $(this);
                //获取productids数据
                var productIDs = [];
                var $ids = $tuijian.find("input[name=tuijianid]");
                $ids.each(function (i, item) {
                    var $item = $(item);
                    if ($item.attr("pass") != "1")
                        return true;
                    var v = $item.val();
                    if (productIDs.indexOf(v) == -1) {
                        productIDs.push(v);
                    }
                });
                if (productIDs.length > 0) {
                    //提交
                    $.post("/product/Related_BestRecommend", { productid: productid, productIDs: productIDs.join(",") },
                        function (data) {
                            if (data.status) {
                                var $gou = $("<p class='gou'>保存成功</p>");
                                $this.after($gou);
                                jx.autoHide($gou);
                                //成功,刷新table数据
                                $tuijian.find("div.infoTable").load("/product/Related?type=3&productid=" + productid);
                            }
                            else {
                                jx.error("提交失败!" + data.msg);
                            }
                        });
                }
                else {
                    jx.alert("您需要填写数据!");
                }
                return false;
            })
            .on("click", "a[name=del]", function () {
                var $this = $(this);
                var pid = $this.attr("productid");
                var childproductid = $this.attr("childproductid");
                jx.del(function () {
                    $.post("/product/related_del", { productid: pid, childproductid: childproductid, type: 2 }, function (result) {
                        if (result.status) {
                            jx.alert("删除推荐商品成功!");
                            $this.parent().parent().remove();

                            //搜索
                            $tuijian.find(".shortinput").each(function (i, item) {
                                if ($(item).val() == childproductid) {
                                    $(item).val('').attr("old", "0").attr("pass", "0").next().html('');
                                    return false;
                                }
                                return true;
                            });
                        }
                    });
                });
                return false;
            });
        //检查数据
        var t;
        $tuijian.on("change keyup blur", "input[name=tuijianid]", function () {
            var $this = $(this);
            var value = $this.val();
            if ($this.attr("old") == value) {
                return false;
            }
            clearTimeout(t);
            $this.attr("pass", "0");
            var $next = $this.next().html('').removeClass("error");

            if (value == '')
                return false;
            if (!/^\d{2,8}$/.test(value)) {
                $next.html("数据错误!请填写数字!").addClass("error");
            }
            else {
                t = setTimeout(function () {
                    $this.attr("old", value);
                    product.getProductByID(value, function (data) {
                        if (data.status) {
                            $this.attr("pass", "1");
                            $next.html("<a href='http://www.jxdyf.com/product/" + data.data.ProductID + ".html'>" + data.data.ChineseName + "</a>");
                        }
                        else {
                            $next.html("没有找到该商品ID");
                        }
                    });
                }, 500);
            }
        });

        //加载推荐数据到编辑框

        function setItemsShow() {
            var $inputlist = $tuijian.find("input");
            $tuijian.find("table tr").slice(1).each(function (i, item) {
                $inputlist.eq(i).attr("pass", "1").val($(item).children().eq(1).text());
                $inputlist.eq(i).next().html("<a href='#'>" + $(item).children().eq(2).text() + "</a>");
            });
        }
        setItemsShow();
    },

    //规格
    guige: function () {
        var $guige = $("#guige");
        var productid = parseInt($guige.find(".pid").text());

        var $childid = $guige.find("input[name=childid]");
        var $viewname = $guige.find("input[name=viewname]");
        var t;
        //检查数据
        $childid.bind("change blur keyup", function () {
            var $this = $(this);
            var value = $this.val();
            if ($this.attr("old") == value) {
                return false;
            }
            clearTimeout(t);
            $this.attr("pass", "0");
            var $next = $this.next().html('').removeClass("error");

            if (value == '')
                return false;
            if (!/^\d{2,8}$/.test(value)) {
                $next.html("数据错误!请填写数字!").addClass("error");
            }
            else {
                t = setTimeout(function () {
                    $this.attr("old", value);
                    product.getProductByID(value, function (data) {
                        if (data.status) {
                            $this.attr("pass", "1");
                            $next.html("<a href='http://www.jxdyf.com/product/" + data.data.ProductID + ".html'>" + data.data.ChineseName + "</a>  规格:" + data.data.Specifications);
                            $viewname.val(data.data.ChineseName + "(" + data.data.Specifications + ")");
                        }
                        else {
                            $next.html("没有找到该商品ID");
                        }
                    });
                }, 500);
            }
        });
        //保存
        $guige.find("a[name=save]").click(function () {
            var $this = $(this);
            var id = parseInt($childid.val());
            var name = $viewname.val();
            if (isNaN(id) || name.length == 0)
                return false;
            $.post("/product/related_differentspec", { productid: productid, childproductid: id, name: name }, function (data) {
                if (data.status) {
                    var $gou = $("<p class='gou'>保存成功</p>");
                    $this.after($gou);
                    setTimeout(function () { $gou.remove() }, 2000);
                    //成功,刷新table数据
                    $guige.find('.infoTable').load("/product/Related?type=2&productid=" + productid);
                    $childid.val('').next().html('');
                    $viewname.val('');
                }
                else {
                    jx.error("提交失败!" + data.msg);
                }
            });
            return false;
        });
        //修改
        $guige.find("div.infoTable")
            .on("click", "a[name=update]", function () {
                var $this = $(this);
                var tds = $this.parent().parent().children();
                $childid.val(tds.eq(1).text());
                $viewname.val(tds.eq(4).text())
                $childid.next().html("<a href='#'>" + tds.eq(2).text() + "</a>");
            })
            .on("click", "a[name=del]", function () {
                var $this = $(this);
                var $parent = $this.parent();
                var productid = $parent.attr('productid');
                var childproductid = $parent.attr("childproductid");
                jx.del(function () {
                    $.post("/product/related_del", { productid: productid, childproductid: childproductid, type: 2 }, function (data) {
                        if (data.status) {
                            jx.alert("删除成功!");
                            $parent.parent().remove();
                        } else {
                            jx.alert(data.msg);
                        }
                    });
                });
                return false;
            });
    },

    //组合
    zuhe: function () {


        var $zuhe = $("#zuhe");
        var productid = parseInt($zuhe.find(".pid").text());
        var productname = $zuhe.find(".pname").text()
        var unit = $zuhe.find(".unit").text()


        var $temptab = $zuhe.find('#temptab');
        var $childid = $zuhe.find("input[name=childid]");
        var $childprice = $zuhe.find("input[name=childprice]");
        var $childcount = $zuhe.find("input[name=childcount]");
        var $viewname = $zuhe.find('input[name=viewname]');

        var $comboname = $temptab.find('input[name=comboname]');
        var $submitcombo = $temptab.find("a[name=submitcombo]");

        var defaulttr = $temptab.find("tbody").html();  //默认当前商品的tr 先备份 
        //加载当前数据到组合
        //加载商品信息
        var t;
        $childid.on("keyup change blur", function () {
            var $this = $(this);
            var value = $this.val();
            if ($this.attr("old") == value) {
                return false;
            }
            clearTimeout(t);
            $this.attr("pass", "0");
            var $next = $this.next().html('').removeClass("error");

            if (value == '')
                return false;
            if (!/^\d{2,8}$/.test(value)) {
                $next.html("数据错误!请填写数字!").addClass("error");
            }
            else {
                t = setTimeout(function () {
                    $this.attr("old", value);
                    product.getProductByID(value, function (data) {
                        if (data.status) {
                            $this.attr("pass", "1");
                            $next.html("<a productcode='" + data.data.ProductCode + "' spec='" + data.data.Specifications + "' href='http://www.jxdyf.com/product/" + data.data.ProductID + ".html'>" + data.data.ChineseName + "</a>  规格:" + data.data.Specifications);
                            $viewname.val(data.data.ChineseName + "(" + data.data.Specifications + ")");
                        }
                        else {
                            $next.html("没有找到该商品ID");
                        }
                    });
                }, 500);
            }
        });
        $childprice.on("keyup change blur", function () {
            var value = $(this).val();
            var iserror = /^\d*(\d|(\.[1-9]{1,2}))$/.test(value);
            var $msg = $childprice.next().next();
            if (!iserror)
                $msg.html("请输入正确的价格").addClass("error");
            else
                $msg.html('').removeClass("error");
        });
        $childcount.on("keyup change blur", function () {
            var value = $(this).val();
            var iserror = /^\d{1,5}$/.test(value);
            var $msg = $childcount.next().next();
            if (!iserror)
                $msg.html("请输入正确的数量").addClass("error");
            else
                $msg.html('').removeClass("error");
        });
        $zuhe.find('a[name=save]').on("click", function () {
            setViewTemp(); return false;
        });


        var updatecombo_productid = 0;
        var isupdate = 0;
        $submitcombo.on("click", function () {

            var mainproductid = productid;
            var comboname = $comboname.val();

            if (isupdate > 0) {
                jx.alert("您正在编辑中!");
                return false;
            }

            //组合子商品数据
            var data = [];
            data.push("<items>");
            $temptab.find("tbody>tr").each(function (i, item) {
                var tds = $(item).children();
                data.push("<item>");
                data.push("<comboproductid>" + tds.eq(0).text() + "</comboproductid>");
                data.push("<name>" + tds.eq(4).text() + "</name>");
                data.push("<price>" + tds.eq(5).text() + "</price>");
                data.push("<quantity>" + tds.eq(6).attr("quantity") + "</quantity>");
                data.push("</item>");
            });
            data.push("</items>");
            //提交组合,并且生成数据  updatecombo_productid 在编辑时赋值
            if (updatecombo_productid == 0) {
                $.post("/product/combo", { mainproductid: mainproductid, comboname: comboname, data: encodeURIComponent(data.join('')) }, function (result) {
                    if (result.status) {
                        var $gou = $("<p class='gou'>保存成功</p>")
                        $submitcombo.after($gou);
                        setTimeout(function () { $gou.remove(); }, 2000);
                        $zuhe.find("table:last").load("/product/combo?productid=" + mainproductid);
                    }
                    else {
                        jx.alert("失败!" + result.msg);
                    }
                });
            }
            else {
                //修改
                $.post("/product/combo", { productid: updatecombo_productid, comboname: comboname, data: encodeURIComponent(data.join('')) }, function (result) {
                    if (result.status) {
                        var $gou = $("<p class='gou'>保存成功</p>")
                        $temptab.find("a.cancel").after($gou).hide();
                        setTimeout(function () { $gou.remove(); }, 2000);
                        $zuhe.find("table:last").load("/product/combo?productid=" + mainproductid);
                    } else {
                        jx.alert("失败!" + result.msg);
                    }
                });
            }
            //重置信息
            $temptab.find("tbody").html(defaulttr);
            $comboname.val('');
            return false;
        });


        //删除套餐  判断是否是修改,是修改取消修改状态
        $zuhe.on("click", ".taoCanZH a[name=del]", function () {
            var $this = $(this);
            var productid = $(this).parent().attr("productid");
            jx.del(function () {
                $.post("/product/combodel", { productid: productid }, function (result) {
                    if (result.status) {
                        jx.alert("删除套餐成功!");
                        $this.parent().parent().remove();

                        if (productid == updatecombo_productid) {
                            updatecombo_productid = 0;
                            $temptab.find("tbody").html(defaulttr);
                        }
                    } else {
                        jx.alert("失败!" + data.msg);
                    }
                });
            });
            return false;
        });
        $zuhe.on("click", "a[name=delrow]", function () {
            var $this = $(this);
            jx.del(function () {
                $this.parent().parent().remove();
            });
            return false;
        });
        //修改套餐
        $zuhe.on("click", ".taoCanZH a[name=update]", function () {
            var productid = $(this).parent().attr("productid");
            $.post("/product/ComboDetail", { productid: productid }, function (result) {
                if (result.status) {
                    var html = [];
                    for (i = 0; i < result.data.length; i++) {
                        var item = result.data[i];
                        html.push('<tr><td>' + item.ComboProductID + '</td><td>' + item.ComboProductCode + '</td><td>' + item.ComboProductName + '</td><td>' + item.Spec + '</td><td>' + item.Name + '</td><td>' + item.Price + '</td><td quantity="' + item.Quantity + '">*' + item.Quantity + item.Unit + '</td><td><a href="#" name="update">编辑</a>' + (item.IsMain ? "" : '<a href="#" name="delrow">删除</a>') + '</td></tr>');
                    }
                    $temptab.find("tbody").html(html.join(''));
                    $temptab.find("a.cancel").show();
                    updatecombo_productid = productid;
                    setZuHeName();
                }
            });
            return false;
        });

        //修改子商品
        $temptab.on("click", "a[name=update]", function () {
            var $this = $(this);
            if ($this.attr("isupdate") == "1") {
                var tds = $this.parent().parent().children();
                var viewname = tds.eq(4).find("input").val();
                var price = tds.eq(5).find('input').val();
                var count = tds.eq(6).find("input").val();
                if (viewname.length == 0 || !/^\d*(\d|(\.[1-9]{1,2}))$/.test(price) || !/^\d{1,5}$/.test(count) || price <= 0 || count <= 0) {
                    jx.alert('请确认参数!');
                    return false;
                }
                tds.eq(4).html(viewname);
                tds.eq(5).html(price);
                tds.eq(6).html("*" + count + tds.eq(6).text()).attr("quantity", count);
                $this.attr("isupdate", "0");
                isupdate--;
                $this.next().show();
                $this.text("编辑")
                setZuHeName();
            }
            else {
                $this.attr("isupdate", "1");
                var tds = $this.parent().parent().children();
                tds.eq(4).html("<input type='text' value='" + tds.eq(4).html() + "' style='width:260px;' />");
                tds.eq(5).html("<input type='text' value='" + tds.eq(5).html() + "' />");
                tds.eq(6).html("<input type='text' value='" + tds.eq(6).attr("quantity") + "' />" + tds.eq(6).text().substr(-1));
                $this.next().hide()
                $this.text("保存");
                isupdate++;
            }
            return false;
        });

        $temptab.find("a.cancel").click(function () {
            $temptab.find("tbody").html(defaulttr);
            updatecombo_productid = 0;
            $(this).hide();
            return false;
        });

        function setViewTemp() {
            var id = $childid.val();
            var price = $childprice.val();
            var count = $childcount.val();
            var product = $childid.next().find("a");
            var productname = product.html();

            var unit = $childcount.next().html();
            var html = '<tr><td>' + id + '</td><td>' + product.attr("productcode") + '</td><td>' + productname + '</td><td>' + product.attr("spec") + '</td><td>' + $viewname.val() + '</td><td>' + price + '</td><td quantity="' + count + '">*' + count + unit + '</td><td><a href="#" name="del">删除</a></td></tr>';
            html = $(html).find("a[name=del]").click(function () { $(this).parent().parent().remove(); return false; }).end();
            $temptab.find('tbody').append(html);

            $childid.val('').next().html('');
            $childcount.val('');
            $childprice.val('');
            $viewname.val('');

            setZuHeName();
        }
        function setZuHeName() {
            var tds;
            var str = [];
            $temptab.find("tbody>tr").each(function (i, item) {
                tds = $(item).children();
                str.push(tds.eq(4).html() + tds.eq(6).html());
            });
            $comboname.val(str.join('+'));
        }
    },

    clearItem: function ($p) {
        $p.find(".spInput input").val('');
    }
}

