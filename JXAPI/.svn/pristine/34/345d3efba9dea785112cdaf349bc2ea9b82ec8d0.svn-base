using JXAPI.Component.Model;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Linq;
using System.Text;

namespace JXAPI.Component.SQLServerDAL
{
    public partial class OrdersMySqlDAL
    {
        /// <summary>
        /// 查询出所有将要超时订单 
        /// </summary>
        /// <param name="numberHour">订单超时时间</param>
        /// <returns></returns>
        public IList<OrdersInfo> OrdersMySql_GetAll(int numberHour)
        {
            IList<OrdersInfo> couponInfoList = new List<OrdersInfo>();
            string sql = string.Empty;
            sql += " SELECT UID,OrderID,CreateTime FROM  Orders ";
            sql += " WHERE  PayStatus=0 AND PaymentMethodID>0 AND CreateTime < '{0}' ";
            sql = string.Format(sql, DateTime.Now.AddHours(numberHour));
            DbCommand cmd = dbr.GetSqlStringCommand(sql);
            using (IDataReader dataReader = dbr.ExecuteReader(cmd))
            {
                while (dataReader.Read())
                {
                    couponInfoList.Add(RecoverModel(dataReader));
                }
            }
            return couponInfoList;
        }

        /// <summary>
        /// 从 IDataReader 中恢复OrdersInfo对象
        /// </summary>
        /// <param name="IDataReader"></param>
        /// <returns></returns>
        public OrdersInfo RecoverModel(IDataReader dataReader)
        {
            OrdersInfo ordersInfo = new OrdersInfo();
            ordersInfo.UID = dataReader["UID"].ToInt();
            ordersInfo.OrderID = dataReader["OrderID"].ToString();
            ordersInfo.CreateTime = dataReader["CreateTime"].ToDateTime();
            return ordersInfo;
        }
    }
}
